<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HBAR/USDT - Trading</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #131722;
      --bg-secondary: #1e222d;
      --bg-tertiary: #2a2e39;
      --text-primary: #d1d4dc;
      --text-secondary: #787b86;
      --accent-green: #26a69a;
      --accent-red: #ef5350;
      --accent-blue: #2962ff;
      --border-color: #2a2e39;
    }
    
    .light-theme {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f5;
      --bg-tertiary: #e0e0e0;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --border-color: #e0e0e0;
    }
    
    body { 
      background: var(--bg-primary); 
      color: var(--text-primary); 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      overflow: hidden;
      height: 100vh;
      transition: background 0.3s, color 0.3s;
    }

    .app { display: flex; height: 100vh; overflow: hidden; }
    
    .toolbar {
      width: 44px;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 0;
      border-right: 1px solid var(--border-color);
    }
    
    .tool-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      margin-bottom: 4px;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.15s;
      font-size: 16px;
      background: transparent;
      border: none;
    }
    .tool-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .tool-btn.active { background: var(--accent-blue); color: #fff; }
    
    .main-area { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    
    .header {
      height: 52px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .symbol-info { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
    .symbol { font-size: 18px; font-weight: 700; color: var(--text-primary); }
    .price-display { 
      font-size: 22px; 
      font-weight: 700; 
      font-family: 'SF Pro Display', -apple-system, 'Roboto Mono', monospace; 
      letter-spacing: -0.5px;
      min-width: 120px;
    }
    .price-up { color: var(--accent-green); }
    .price-down { color: var(--accent-red); }
    
    .daily-change {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Roboto Mono', monospace;
    }
    .daily-up { background: rgba(38, 166, 154, 0.15); color: var(--accent-green); }
    .daily-down { background: rgba(239, 83, 80, 0.15); color: var(--accent-red); }
    
    .signal-badge {
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .signal-buy { background: rgba(38, 166, 154, 0.15); color: var(--accent-green); }
    .signal-sell { background: rgba(239, 83, 80, 0.15); color: var(--accent-red); }
    .signal-neutral { background: var(--bg-tertiary); color: var(--text-secondary); }
    
    .header-actions { margin-left: auto; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    
    .timeframe-bar {
      display: flex;
      gap: 2px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      padding: 3px;
    }
    
    .tf-btn {
      padding: 6px 12px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .tf-btn:hover { color: var(--text-primary); }
    .tf-btn.active { background: var(--bg-secondary); color: var(--text-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    
    .header-btn {
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .header-btn:hover { background: var(--accent-blue); color: #fff; }
    
    .balance-display-header {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      padding: 6px 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      min-width: 100px;
    }
    .balance-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    .balance-value-header { font-size: 16px; font-weight: 700; color: var(--accent-green); font-family: 'Roboto Mono', monospace; }
    
    .content { flex: 1; display: flex; overflow: hidden; min-height: 0; }
    
    .chart-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    #chart { flex: 1; min-height: 0; }
    #volume-chart { height: 100px; border-top: 1px solid var(--border-color); }
    
    .right-panel {
      width: 300px;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      min-height: 0;
    }
    
    .panel-section {
      padding: 14px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .panel-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }
    
    .indicator-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 12px;
    }
    .indicator-label { color: var(--text-secondary); }
    .indicator-value { font-weight: 600; font-family: 'Roboto Mono', monospace; }
    
    .section-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .order-book {
      max-height: 200px;
      overflow: hidden;
      font-family: 'SF Mono', 'Roboto Mono', monospace;
      font-size: 11px;
    }
    
    .ob-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
    }
    .ob-row span:first-child { min-width: 80px; text-align: right; }
    .ob-ask { color: var(--accent-red); }
    .ob-bid { color: var(--accent-green); }
    
    .trading-panel {
      padding: 14px;
      display: flex;
      flex-direction: column;
    }
    
    .trade-input {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 10px 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .trade-input:focus { outline: none; border-color: var(--accent-blue); }
    
    .trade-btn-row { display: flex; gap: 10px; margin-bottom: 14px; }
    
    .trade-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .trade-btn.buy { background: var(--accent-green); color: #fff; }
    .trade-btn.buy:hover { filter: brightness(1.1); }
    .trade-btn.sell { background: var(--accent-red); color: #fff; }
    .trade-btn.sell:hover { filter: brightness(1.1); }
    
    .position-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 12px;
      align-items: center;
    }
    
    .pnl-positive { color: var(--accent-green); }
    .pnl-negative { color: var(--accent-red); }
    
    .stats-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 12px;
    }
    
    .balance-display {
      background: var(--bg-primary);
      padding: 14px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 14px;
    }
    .balance-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
    .balance-value { font-size: 24px; font-weight: 700; color: var(--text-primary); margin-top: 6px; font-family: 'Roboto Mono', monospace; }
    
    .calc-input {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .calc-input:focus { outline: none; border-color: var(--accent-blue); }
    
    .calc-btn {
      width: 100%;
      background: var(--accent-blue);
      border: none;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
    }
    .calc-btn:hover { filter: brightness(1.1); }
    
    .status-bar {
      height: 32px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-top: 1px solid var(--border-color);
      font-size: 11px;
      color: var(--text-secondary);
      gap: 16px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }
    .status-dot.live { background: var(--accent-green); }
    
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(19, 23, 34, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 1000;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--bg-tertiary);
      border-top-color: var(--accent-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .loading-text { margin-top: 20px; color: var(--text-primary); font-size: 16px; font-weight: 600; }
    .loading-sub { margin-top: 10px; color: var(--text-secondary); font-size: 13px; }
    
    .alerts-section {
      padding: 14px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .alert-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: var(--bg-primary);
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    
    .alert-price { font-weight: 600; font-family: 'Roboto Mono', monospace; }
    .alert-above { color: var(--accent-green); }
    .alert-below { color: var(--accent-red); }
    
    .alert-delete {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      font-size: 14px;
    }
    .alert-delete:hover { color: var(--accent-red); }
    
    .add-alert-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .add-alert-input {
      flex: 1;
      padding: 8px 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 12px;
    }
    
    .add-alert-btn {
      padding: 8px 14px;
      background: var(--accent-green);
      border: none;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .journal-section {
      padding: 14px;
      border-bottom: 1px solid var(--border-color);
      max-height: 200px;
      overflow-y: auto;
    }
    
    .journal-item {
      padding: 10px;
      background: var(--bg-primary);
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 11px;
    }
    
    .journal-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .journal-type {
      font-weight: 700;
      text-transform: uppercase;
    }
    .journal-buy { color: var(--accent-green); }
    .journal-sell { color: var(--accent-red); }
    
    .journal-pnl {
      font-weight: 700;
      font-family: 'Roboto Mono', monospace;
    }
    
    .journal-note {
      color: var(--text-secondary);
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid var(--border-color);
    }
    
    .journal-note-input {
      width: 100%;
      padding: 6px 8px;
      background: var(--bg-tertiary);
      border: none;
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 11px;
      margin-top: 6px;
    }
    
    .close-alert-btn {
      padding: 4px 8px;
      background: var(--accent-red);
      border: none;
      color: #fff;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
      margin-left: 8px;
    }
    
    .shortcut-hint {
      position: fixed;
      bottom: 40px;
      right: 320px;
      background: var(--bg-secondary);
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 11px;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      max-width: 300px;
    }
    
    .shortcut-hint kbd {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Roboto Mono', monospace;
      margin: 0 2px;
    }
    
    @media (max-width: 900px) {
      .right-panel { width: 260px; }
      .toolbar { width: 36px; }
      .tool-btn { width: 28px; height: 28px; font-size: 12px; }
      .header { padding: 0 12px; height: 44px; }
      .symbol { font-size: 14px; }
      .price-display { font-size: 16px; min-width: 80px; }
      .daily-change { display: none; }
      .balance-display-header { padding: 4px 8px; min-width: 80px; }
      .balance-value-header { font-size: 12px; }
    }
    
    @media (max-width: 700px) {
      .right-panel { display: none; }
      .shortcut-hint { right: 10px; }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Loading Chart</div>
    <div id="load-status" class="loading-sub">Connecting to Binance...</div>
  </div>

  <div class="app">
    <div class="toolbar">
      <div class="tool-btn" onclick="setTool('crosshair')" title="Crosshair (C)">⊕</div>
      <div class="tool-btn" id="tool-hline" onclick="setTool('hline')" title="Horizontal Line (H)">━</div>
      <div class="tool-btn" id="tool-trend" onclick="setTool('trend')" title="Trendline (T)">╱</div>
      <div class="tool-btn" onclick="setTool('vert')" title="Vertical Line (V)">|</div>
      <div class="tool-btn" onclick="clearDrawings()" title="Clear All (X)">✕</div>
    </div>

    <div class="main-area">
      <header class="header">
        <div class="symbol-info">
          <span class="symbol">HBAR/USDT</span>
          <span id="price" class="price-display">---</span>
          <span id="daily-change" class="daily-change daily-neutral">---</span>
          <span id="signal" class="signal-badge signal-neutral">WAIT</span>
        </div>
        <div class="header-actions">
          <div class="timeframe-bar">
            <button class="tf-btn" onclick="setTimeframe('1m')">1m</button>
            <button class="tf-btn" onclick="setTimeframe('5m')">5m</button>
            <button class="tf-btn" onclick="setTimeframe('15m')">15m</button>
            <button class="tf-btn" onclick="setTimeframe('30m')">30m</button>
            <button class="tf-btn active" onclick="setTimeframe('1h')">1H</button>
            <button class="tf-btn" onclick="setTimeframe('4h')">4H</button>
            <button class="tf-btn" onclick="setTimeframe('1d')">1D</button>
          </div>
          <button class="header-btn" onclick="toggleTheme()" title="Toggle Theme">☀</button>
          <div class="balance-display-header">
            <span class="balance-label">Balance</span>
            <span id="demo-balance-header" class="balance-value-header">$10,000</span>
          </div>
        </div>
      </header>

      <div class="content">
        <div class="chart-area">
          <div id="chart"></div>
          <div id="volume-chart"></div>
        </div>

        <div class="right-panel">
          <div class="panel-section">
            <div class="panel-title">Technical Indicators</div>
            <div class="section-grid">
              <div>
                <div class="indicator-row"><span class="indicator-label">RSI (14)</span><span id="rsi" class="indicator-value">---</span></div>
                <div class="indicator-row"><span class="indicator-label">Stoch K</span><span id="stochK" class="indicator-value">---</span></div>
                <div class="indicator-row"><span class="indicator-label">Stoch D</span><span id="stochD" class="indicator-value">---</span></div>
                <div class="indicator-row"><span class="indicator-label" style="color:#f9a825">VWAP</span><span id="vwap" class="indicator-value">---</span></div>
              </div>
              <div>
                <div class="indicator-row"><span class="indicator-label" style="color:#f9a825">EMA 9</span><span id="ema9" class="indicator-value">---</span></div>
                <div class="indicator-row"><span class="indicator-label" style="color:#42a5f5">EMA 20</span><span id="ema20" class="indicator-value">---</span></div>
                <div class="indicator-row"><span class="indicator-label" style="color:#ef5350">EMA 50</span><span id="ema50" class="indicator-value">---</span></div>
                <div class="indicator-row"><span class="indicator-label" style="color:#9c27b0">ATR (14)</span><span id="atr" class="indicator-value">---</span></div>
              </div>
            </div>
          </div>

          <div class="panel-section">
            <div class="panel-title">MACD / Bollinger</div>
            <div class="indicator-row"><span class="indicator-label">MACD</span><span id="macd" class="indicator-value">---</span></div>
            <div class="indicator-row"><span class="indicator-label">Signal</span><span id="macdSignal" class="indicator-value">---</span></div>
            <div class="indicator-row"><span class="indicator-label">Hist</span><span id="hist" class="indicator-value">---</span></div>
            <div class="indicator-row"><span class="indicator-label">BB Upper</span><span id="bbUpper" class="indicator-value">---</span></div>
            <div class="indicator-row"><span class="indicator-label">BB Middle</span><span id="bbMiddle" class="indicator-value">---</span></div>
            <div class="indicator-row"><span class="indicator-label">BB Lower</span><span id="bbLower" class="indicator-value">---</span></div>
          </div>

          <div class="alerts-section">
            <div class="panel-title">Price Alerts</div>
            <div id="alerts-list"></div>
            <div class="add-alert-row">
              <input type="number" id="alert-price" class="add-alert-input" placeholder="Price" step="0.00000001">
              <button class="add-alert-btn" onclick="addAlert()">+</button>
            </div>
          </div>

          <div class="panel-section">
            <div class="panel-title">Order Book</div>
            <div class="order-book" id="order-book">
              <div class="ob-row" style="color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">
                <span>Price</span><span>Size</span>
              </div>
              <div id="ob-asks"></div>
              <div id="ob-spread" style="text-align:center;padding:10px 0;color:var(--text-secondary);font-size:11px;">---</div>
              <div id="ob-bids"></div>
            </div>
          </div>

          <div class="trading-panel">
            <div class="panel-title">Paper Trading</div>
            
            <input type="number" id="trade-amount" class="trade-input" placeholder="Amount (USD)" value="100">
            <div class="trade-btn-row">
              <button class="trade-btn buy" onclick="paperBuy()">BUY</button>
              <button class="trade-btn sell" onclick="paperSell()">SELL</button>
            </div>
            
            <div class="panel-title" style="margin-top:12px;">Open Positions</div>
            <div id="open-positions" style="max-height:120px;overflow-y:auto;">
              <div style="text-align:center;color:var(--text-secondary);padding:16px;font-size:12px;">No open positions</div>
            </div>
            
            <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border-color);">
              <div class="stats-row">
                <span class="indicator-label">Total P&L</span>
                <span id="total-pnl" class="indicator-value">$0.00</span>
              </div>
              <div class="stats-row">
                <span class="indicator-label">Win Rate</span>
                <span id="win-rate" class="indicator-value">0%</span>
              </div>
            </div>
            
            <button onclick="resetDemo()" style="width:100%;margin-top:14px;background:var(--bg-tertiary);border:none;color:var(--text-secondary);padding:10px;font-size:12px;cursor:pointer;border-radius:6px;">Reset Demo</button>
            
            <div class="panel-title" style="margin-top:18px;">Position Calculator</div>
            <input type="number" id="calcBalance" class="calc-input" placeholder="Balance" value="1000">
            <input type="number" id="calcRisk" class="calc-input" placeholder="Risk %" value="2" step="0.5">
            <input type="number" id="calcStopLoss" class="calc-input" placeholder="Stop Loss %" value="5" step="0.5">
            <input type="number" id="calcEntry" class="calc-input" placeholder="Entry Price">
            <button onclick="calculatePosition()" class="calc-btn">Calculate Size</button>
            <div class="indicator-row" style="margin-top:10px;">
              <span class="indicator-label">Position</span>
              <span id="posSize" style="color:var(--accent-green);">---</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">Risk</span>
              <span id="posRisk" style="color:var(--accent-red);">---</span>
            </div>
            
            <div class="panel-title" style="margin-top:18px;">Trade Journal</div>
            <div id="journal-list" class="journal-section"></div>
          </div>
        </div>
      </div>

      <footer class="status-bar">
        <div id="dot" class="status-dot"></div>
        <span id="status">Connecting...</span>
        <span id="candle-count"></span>
        <span id="daily-high-low"></span>
      </footer>
    </div>
  </div>

  <div class="shortcut-hint">
    <strong>Keyboard Shortcuts:</strong><br>
    <kbd>1</kbd>-<kbd>7</kbd> Timeframes &nbsp;|&nbsp; <kbd>B</kbd> Buy &nbsp;|&nbsp; <kbd>S</kbd> Sell<br>
    <kbd>C</kbd> Crosshair &nbsp;|&nbsp; <kbd>H</kbd> H-Line &nbsp;|&nbsp; <kbd>T</kbd> Trend &nbsp;|&nbsp; <kbd>X</kbd> Clear
  </div>

  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pusher-js@8.0.2/dist/web/pusher.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1.16.0/dist/echo.iife.js"></script>
  <script>
    var currentTimeframe = "1h";
    var chartContainer = document.getElementById("chart");
    var loadedCandles = [];
    var isLightTheme = false;
    
    var chart = LightweightCharts.createChart(chartContainer, {
      layout: { background: { type: "solid", color: "#131722" }, textColor: "#787b86" },
      grid: { vertLines: { color: "#1e222d" }, horzLines: { color: "#1e222d" } },
      crosshair: { mode: 1 },
      rightPriceScale: { 
        borderColor: "#2a2e39",
        scaleMargins: { top: 0.02, bottom: 0.1 }
      },
      timeScale: { 
        borderColor: "#2a2e39", 
        timeVisible: true,
        minBarSpacing: 2
      }
    });

    var volumeChart = LightweightCharts.createChart(document.getElementById("volume-chart"), {
      layout: { background: { type: "solid", color: "#131722" }, textColor: "#787b86" },
      grid: { vertLines: { color: "#1e222d" }, horzLines: { color: "#1e222d" } },
      crosshair: { mode: 1 },
      rightPriceScale: { 
        borderColor: "#2a2e39",
        scaleMargins: { top: 0.1, bottom: 0.1 }
      },
      timeScale: { borderColor: "#2a2e39", timeVisible: true }
    });

    var candleSeries = chart.addCandlestickSeries({
      upColor: "#26a69a", downColor: "#ef5350",
      borderUpColor: "#26a69a", borderDownColor: "#ef5350",
      wickUpColor: "#26a69a", wickDownColor: "#ef5350"
    });

    var ema9Line = chart.addLineSeries({ color: "#f9a825", lineWidth: 1 });
    var ema20Line = chart.addLineSeries({ color: "#42a5f5", lineWidth: 1 });
    var ema50Line = chart.addLineSeries({ color: "#ef5350", lineWidth: 1 });
    var vwapLine = chart.addLineSeries({ color: "#f9a825", lineWidth: 1, lineStyle: 2 });
    var atrLine = chart.addLineSeries({ color: "#9c27b0", lineWidth: 1, lineStyle: 3, visible: false });

    var volumeSeries = volumeChart.addHistogramSeries({
      color: "#26a69a",
      priceFormat: { type: "volume" }
    });

    var closes = [];
    var volumes = [];
    var highs = [];
    var lows = [];
    var MAX_DATA = 500;

    var currentTool = null;
    var drawPoints = [];
    var horizontalLines = [];
    var hLineSeries = [];
    var hLinePrices = [];
    var hLineColors = [];
    var trendLineSeries = chart.addLineSeries({ color: "#2962ff", lineWidth: 2, lastValueVisible: false, priceLineVisible: false });
    var dailyHighLine = chart.addLineSeries({ color: "#26a69a", lineWidth: 1, lineStyle: 3, visible: false });
    var dailyLowLine = chart.addLineSeries({ color: "#ef5350", lineWidth: 1, lineStyle: 3, visible: false });

    function setTool(tool) {
      currentTool = tool;
      drawPoints = [];
      document.querySelectorAll(".toolbar .tool-btn").forEach(function(b) { b.classList.remove("active"); });
      if (tool === "hline") document.getElementById("tool-hline").classList.add("active");
      if (tool === "trend") document.getElementById("tool-trend").classList.add("active");
      if (tool === "crosshair") currentTool = null;
    }

    function clearDrawings() {
      hLineSeries.forEach(function(s) { chart.removeSeries(s); });
      hLineSeries = [];
      hLinePrices = [];
      hLineColors = [];
      trendLineSeries.setData([]);
      drawPoints = [];
      saveDrawings();
    }

    function addHorizontalLine(price, color) {
      color = color || "#2962ff";
      var line = chart.addLineSeries({ color: color, lineWidth: 1, lineStyle: 2, lastValueVisible: false, priceLineVisible: false });
      var data = [];
      var logicalRange = chart.timeScale().getVisibleLogicalRange();
      if (logicalRange) {
        for (var t = logicalRange.from; t <= logicalRange.to; t++) {
          data.push({ time: t, value: price });
        }
      }
      line.setData(data);
      hLineSeries.push(line);
      hLinePrices.push(price);
      hLineColors.push(color);
      saveDrawings();
    }

    function loadDrawings() {
      var saved = localStorage.getItem("hbar_drawings");
      if (saved) {
        try {
          var data = JSON.parse(saved);
          if (data.lines && data.lines.length) {
            data.lines.forEach(function(l) {
              addHorizontalLine(l.price, l.color);
            });
          }
        } catch (e) {}
      }
    }

    function saveDrawings() {
      var lines = hLinePrices.map(function(price, i) {
        return { price: price, color: hLineColors[i] };
      });
      localStorage.setItem("hbar_drawings", JSON.stringify({ lines: lines }));
    }

    function calcEMA(data, period) {
      if (data.length < period) return null;
      var k = 2 / (period + 1);
      var ema = data[data.length - period];
      for (var i = data.length - period + 1; i < data.length; i++) {
        ema = data[i] * k + ema * (1 - k);
      }
      return ema;
    }

    function calcSMA(data, period) {
      if (data.length < period) return null;
      var slice = data.slice(-period);
      return slice.reduce(function(a, b) { return a + b; }, 0) / period;
    }

    function calcRSI(data, period) {
      if (data.length < period + 1) return null;
      var gains = 0, losses = 0;
      for (var i = data.length - period; i < data.length; i++) {
        var change = data[i] - data[i - 1];
        if (change > 0) gains += change;
        else losses -= change;
      }
      var rs = gains / (losses || 0.0001);
      return 100 - (100 / (1 + rs));
    }

    function calcMACD(data) {
      if (data.length < 26) return null;
      var ema12 = calcEMA(data, 12);
      var ema26 = calcEMA(data, 26);
      var macdLine = ema12 - ema26;
      var macdData = [];
      for (var i = data.length - 26; i < data.length; i++) {
        var slice = data.slice(0, i + 1);
        var e12 = calcEMA(slice, 12);
        var e26 = calcEMA(slice, 26);
        macdData.push(e12 - e26);
      }
      var signalLine = calcEMA(macdData, 9);
      return { macd: macdLine, signal: signalLine, histogram: macdLine - signalLine };
    }

    function calcBB(data, period, stdDev) {
      if (data.length < period) return null;
      var sma = calcSMA(data, period);
      var slice = data.slice(-period);
      var variance = slice.reduce(function(sum, val) { return sum + Math.pow(val - sma, 2); }, 0) / period;
      var std = Math.sqrt(variance);
      return { upper: sma + stdDev * std, middle: sma, lower: sma - stdDev * std };
    }

    function calcStochRSI(data, period, smoothK, smoothD) {
      if (data.length < period) return null;
      var rsi = calcRSI(data, period);
      if (rsi === null) return null;
      var rsiSlice = [];
      for (var i = 0; i < period; i++) {
        var subSlice = data.slice(0, data.length - period + i + 1);
        rsiSlice.push(calcRSI(subSlice, period));
      }
      var rsiData = rsiSlice.filter(function(x) { return x !== null; });
      if (rsiData.length < period) return null;
      var rsiMin = Math.min.apply(null, rsiData.slice(-period));
      var rsiMax = Math.max.apply(null, rsiData.slice(-period));
      var stochK = ((rsi - rsiMin) / (rsiMax - rsiMin || 1)) * 100;
      var stochD = calcSMA([stochK], smoothD);
      return { k: stochK, d: stochD || null };
    }

    function calcVWAP(closes, highs, lows, volumes) {
      if (closes.length < 1) return null;
      var tpSum = 0, volSum = 0;
      for (var i = Math.max(0, closes.length - 100); i < closes.length; i++) {
        var tp = (closes[i] + highs[i] + lows[i]) / 3;
        tpSum += tp * volumes[i];
        volSum += volumes[i];
      }
      return volSum > 0 ? tpSum / volSum : null;
    }

    function calcATR(highs, lows, closes, period) {
      if (closes.length < period + 1) return null;
      var trs = [];
      for (var i = 1; i < closes.length; i++) {
        var tr = Math.max(highs[i] - lows[i], Math.abs(highs[i] - closes[i - 1]), Math.abs(lows[i] - closes[i - 1]));
        trs.push(tr);
      }
      return calcSMA(trs, period);
    }

    var alerts = [];
    var alertPrice = 0;

    function addAlert() {
      var price = parseFloat(document.getElementById("alert-price").value);
      if (price > 0) {
        alerts.push({ price: price, triggered: false });
        document.getElementById("alert-price").value = "";
        renderAlerts();
      }
    }

    function deleteAlert(index) {
      alerts.splice(index, 1);
      renderAlerts();
    }

    function renderAlerts() {
      var html = "";
      alerts.forEach(function(a, i) {
        var isAbove = a.price > alertPrice;
        html += '<div class="alert-item"><span class="alert-price ' + (isAbove ? 'alert-above' : 'alert-below') + '">' + 
          (isAbove ? "↑ " : "↓ ") + a.price.toFixed(8) + '</span><button class="alert-delete" onclick="deleteAlert(' + i + ')">✕</button></div>';
      });
      document.getElementById("alerts-list").innerHTML = html;
    }

    function checkAlerts(price) {
      alertPrice = price;
      alerts.forEach(function(a) {
        if (!a.triggered) {
          if ((a.price > alertPrice && price >= a.price) || (a.price < alertPrice && price <= a.price)) {
            a.triggered = true;
            alert("Alert: HBAR/USDT reached $" + a.price.toFixed(8));
            renderAlerts();
          }
        }
      });
    }

    function updateUI(candle) {
      if (!candle || candle.c === null || candle.c === undefined) return;
      
      var close = candle.c;
      var high = candle.h || close;
      var low = candle.l || close;
      var volume = candle.v || 0;
      var now = Number(candle.time);
      
      closes.push(close);
      highs.push(high);
      lows.push(low);
      volumes.push(volume);
      
      if (closes.length > MAX_DATA) {
        closes.shift();
        highs.shift();
        lows.shift();
        volumes.shift();
      }
      
      var rsi = calcRSI(closes, 14);
      var ema9 = calcEMA(closes, 9);
      var ema20 = calcEMA(closes, 20);
      var ema50 = calcEMA(closes, 50);
      var macd = calcMACD(closes);
      var bb = calcBB(closes, 20, 2);
      var volSma = calcSMA(volumes, 20);
      var stochRSI = calcStochRSI(closes, 14, 3, 3);
      var vwap = calcVWAP(closes, highs, lows, volumes);
      var atr = calcATR(highs, lows, closes, 14);
      
      if (close === null || close === undefined) return;
      
      document.getElementById("price").textContent = close.toFixed(8);
      checkAlerts(close);
      
      var prevCloseData = loadedCandles.length > 1 ? loadedCandles[loadedCandles.length - 2] : null;
      var prevClose = (prevCloseData && prevCloseData.c !== null && prevCloseData.c !== undefined) ? prevCloseData.c : close;
      var priceClass = (close || 0) >= (prevClose || 0) ? "price-display price-up" : "price-display price-down";
      document.getElementById("price").className = priceClass;
      
      document.getElementById("rsi").textContent = rsi ? rsi.toFixed(2) : "---";
      document.getElementById("ema9").textContent = ema9 ? ema9.toFixed(8) : "---";
      document.getElementById("ema20").textContent = ema20 ? ema20.toFixed(8) : "---";
      document.getElementById("ema50").textContent = ema50 ? ema50.toFixed(8) : "---";
      document.getElementById("macd").textContent = macd ? macd.macd.toFixed(6) : "---";
      document.getElementById("macdSignal").textContent = macd ? macd.signal.toFixed(6) : "---";
      document.getElementById("hist").textContent = macd ? macd.histogram.toFixed(6) : "---";
      document.getElementById("bbUpper").textContent = bb ? bb.upper.toFixed(8) : "---";
      document.getElementById("bbMiddle").textContent = bb ? bb.middle.toFixed(8) : "---";
      document.getElementById("bbLower").textContent = bb ? bb.lower.toFixed(8) : "---";
      document.getElementById("stochK").textContent = stochRSI && stochRSI.k !== null ? stochRSI.k.toFixed(2) : "---";
      document.getElementById("stochD").textContent = stochRSI && stochRSI.d !== null ? stochRSI.d.toFixed(2) : "---";
      document.getElementById("vwap").textContent = vwap ? vwap.toFixed(8) : "---";
      document.getElementById("atr").textContent = atr ? atr.toFixed(8) : "---";
      
      var signalEl = document.getElementById("signal");
      if (rsi !== null) {
        var score = 0;
        if (rsi < 30) score += 2;
        else if (rsi > 70) score -= 2;
        if (ema9 > ema20) score += 1;
        else score -= 1;
        if (macd && macd.histogram > 0) score += 1;
        else if (macd) score -= 1;
        if (stochRSI && stochRSI.k < 20) score += 1;
        else if (stochRSI && stochRSI.k > 80) score -= 1;
        if (stochRSI && stochRSI.k > stochRSI.d && stochRSI.k < 50) score += 1;
        else if (stochRSI && stochRSI.k < stochRSI.d && stochRSI.k > 50) score -= 1;
        
        if (score >= 2) { signalEl.textContent = "BUY"; signalEl.className = "signal-badge signal-buy"; }
        else if (score <= -2) { signalEl.textContent = "SELL"; signalEl.className = "signal-badge signal-sell"; }
        else { signalEl.textContent = "NEUTRAL"; signalEl.className = "signal-badge signal-neutral"; }
      }
      
      if (ema9) ema9Line.update({ time: now, value: ema9 });
      if (ema20) ema20Line.update({ time: now, value: ema20 });
      if (ema50) ema50Line.update({ time: now, value: ema50 });
      if (vwap) vwapLine.update({ time: now, value: vwap });
      if (atr) atrLine.update({ time: now, value: close + atr * 2 });
      
      var prevCloseData = loadedCandles.length > 1 ? loadedCandles[loadedCandles.length - 2] : null;
      var prevClose = (prevCloseData && prevCloseData.c !== null && prevCloseData.c !== undefined) ? prevCloseData.c : close;
      volumeSeries.update({
        time: now,
        value: volume || 0,
        color: (close || 0) >= (prevClose || 0) ? "#26a69a" : "#ef5350"
      });
    }

    function syncTimeScale() {
      var logicalRange = chart.timeScale().getVisibleLogicalRange();
      if (logicalRange) {
        volumeChart.timeScale().setVisibleLogicalRange(logicalRange);
      }
    }

    chart.timeScale().subscribeVisibleLogicalRangeChange(syncTimeScale);

    function loadCandles(timeframe) {
      document.getElementById("loading").style.display = "flex";
      document.getElementById("load-status").textContent = "Fetching " + timeframe + " data...";
      
      fetch("/api/candles?timeframe=" + timeframe)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          document.getElementById("load-status").textContent = "Loaded " + data.length + " candles";
          
          if (data.length > 0) {
            loadedCandles = data;
            closes = data.map(function(c) { return c.c; });
            highs = data.map(function(c) { return c.h; });
            lows = data.map(function(c) { return c.l; });
            volumes = data.map(function(c) { return c.v || 0; });
            
            var candleData = data.map(function(c) {
              return { time: c.time, open: c.o, high: c.h, low: c.l, close: c.c };
            });
            
            candleSeries.setData(candleData);
            
            var volumeData = data.map(function(c) {
              return {
                time: c.time,
                value: c.v || 0,
                color: c.c >= c.o ? "#26a69a" : "#ef5350"
              };
            });
            volumeSeries.setData(volumeData);
            
            document.getElementById("candle-count").textContent = data.length + " candles";
            
            var dailyHigh = Math.max.apply(null, data.map(function(c) { return c.h; }));
            var dailyLow = Math.min.apply(null, data.map(function(c) { return c.l; }));
            document.getElementById("daily-high-low").textContent = "H: " + dailyHigh.toFixed(8) + " | L: " + dailyLow.toFixed(8);
            
            var firstClose = data[0].c;
            var lastCandle = data[data.length - 1];
            var change = ((lastCandle.c - firstClose) / firstClose) * 100;
            var changeEl = document.getElementById("daily-change");
            changeEl.textContent = (change >= 0 ? "+" : "") + change.toFixed(2) + "%";
            changeEl.className = "daily-change " + (change >= 0 ? "daily-up" : "daily-down");
            
            if (lastCandle && lastCandle.c !== undefined) {
              updateUI(lastCandle);
            }
          }
          
          document.getElementById("loading").style.display = "none";
          
          document.querySelectorAll(".tf-btn").forEach(function(b) {
            b.classList.remove("active");
            var tfDisplay = timeframe.replace("4h", "4H").replace("h", "H").replace("d", "D");
            if (b.textContent.toLowerCase() === tfDisplay.toLowerCase()) {
              b.classList.add("active");
            }
          });
        })
        .catch(function(err) {
          console.error("Error loading candles:", err);
          document.getElementById("load-status").textContent = "Error loading data";
          document.getElementById("loading").style.display = "none";
        });
    }

    function setTimeframe(tf) {
      currentTimeframe = tf;
      loadCandles(tf);
    }

    // Initialize Laravel Echo for Reverb
    window.Pusher = Pusher;
    
    const echo = new Echo({
      broadcaster: 'reverb',
      key: 'hbar_trading_key',
      wsHost: 'localhost',
      wsPort: 8080,
      forceTLS: false,
      disableStats: true,
    });
    
    echo.channel('candles.HBARUSDT')
      .listen('.candle', function(data) {
        if (!data || data.c === null || data.c === undefined) return;
        
        var candle = { time: data.time, open: data.o, high: data.h, low: data.l, close: data.c, v: data.v || 0 };
        
        if (loadedCandles.length > 0) {
          var last = loadedCandles[loadedCandles.length - 1];
          if (last && last.time === data.time) {
            loadedCandles[loadedCandles.length - 1] = data;
            candleSeries.update(candle);
            volumeSeries.update({
              time: data.time,
              value: data.v || 0,
              color: (data.c || 0) >= (last.o || data.o || 0) ? "#26a69a" : "#ef5350"
            });
          } else {
            loadedCandles.push(data);
            candleSeries.update(candle);
            volumeSeries.update({
              time: data.time,
              value: data.v || 0,
              color: (data.c || 0) >= (data.o || 0) ? "#26a69a" : "#ef5350"
            });
          }
        }
        
        updateUI(data);
      });
    
    echo.connector.pusher.connection.bind('connected', function() {
      document.getElementById("status").textContent = "Live";
      document.getElementById("dot").classList.add("live");
    });
    
    echo.connector.pusher.connection.bind('disconnected', function() {
      document.getElementById("status").textContent = "Disconnected";
      document.getElementById("dot").classList.remove("live");
    });

    var orderBookWS = new WebSocket("wss://stream.binance.com:9443/ws/hbarusdt@depth10");

    orderBookWS.onopen = function() { console.log("Order book connected"); };
    orderBookWS.onerror = function() { console.log("Order book connection failed - will retry"); };
    orderBookWS.onmessage = function(event) {
      try {
        var json = JSON.parse(event.data);
        var bids = json.bids || [];
        var asks = (json.asks || []).reverse();
        
        var askHtml = "";
        asks.slice(0, 5).forEach(function(a) {
          if (a && a[0] !== undefined) {
            askHtml += '<div class="ob-row"><span class="ob-ask">' + parseFloat(a[0]).toFixed(8) + '</span><span>' + parseFloat(a[1] || 0).toFixed(0) + '</span></div>';
          }
        });
        document.getElementById("ob-asks").innerHTML = askHtml;
        
        var bidHtml = "";
        bids.slice(0, 5).forEach(function(b) {
          if (b && b[0] !== undefined) {
            bidHtml += '<div class="ob-row"><span class="ob-bid">' + parseFloat(b[0]).toFixed(8) + '</span><span>' + parseFloat(b[1] || 0).toFixed(0) + '</span></div>';
          }
        });
        document.getElementById("ob-bids").innerHTML = bidHtml;
        
        if (bids.length > 0 && asks.length > 0 && asks[asks.length - 1] && bids[0]) {
          var spread = parseFloat(asks[asks.length - 1][0]) - parseFloat(bids[0][0]);
          var spreadPercent = (spread / parseFloat(bids[0][0])) * 100;
          document.getElementById("ob-spread").textContent = "Spread: " + spread.toFixed(8) + " (" + spreadPercent.toFixed(2) + "%)";
        }
      } catch (e) {}
    };

    chart.subscribeClick(function(param) {
      if (!currentTool || !param.point || !param.time) return;
      var price = chart.priceScale("right").coordinateToPrice(param.point.y);
      if (currentTool === "hline" && price) {
        addHorizontalLine(price);
      } else if (currentTool === "trend") {
        drawPoints.push({ time: param.time, value: price });
        if (drawPoints.length === 2) {
          var data = [drawPoints[0], drawPoints[1]];
          trendLineSeries.setData(data);
          drawPoints = [];
          currentTool = null;
          document.querySelectorAll(".toolbar .tool-btn").forEach(function(b) { b.classList.remove("active"); });
        }
      }
    });

    chart.timeScale().subscribeVisibleLogicalRangeChange(function() {
      var logicalRange = chart.timeScale().getVisibleLogicalRange();
      hLineSeries.forEach(function(line, idx) {
        var data = [];
        if (logicalRange) {
          for (var t = logicalRange.from; t <= logicalRange.to; t++) {
            data.push({ time: t, value: hLinePrices[idx] });
          }
        }
        line.setData(data);
      });
    });

    var demoBalance = 10000;
    var openPositions = [];
    var tradeHistory = [];
    var currentPrice = 0;

    function updateDemoPrice(price) {
      currentPrice = price;
      document.getElementById("calcEntry").value = price.toFixed(8);
      updatePositionsDisplay();
    }

    function paperBuy() {
      var amount = parseFloat(document.getElementById("trade-amount").value);
      if (!amount || amount <= 0 || amount > demoBalance) {
        alert("Invalid amount");
        return;
      }
      var size = amount / currentPrice;
      openPositions.push({ type: "long", size: size, entryPrice: currentPrice, note: "" });
      demoBalance -= amount;
      updateDemoDisplay();
      addJournalEntry("buy", size, currentPrice, 0);
    }

    function paperSell() {
      var amount = parseFloat(document.getElementById("trade-amount").value);
      if (!amount || amount <= 0) { alert("Invalid amount"); return; }
      var sellSize = amount / currentPrice;
      var longSize = openPositions.filter(function(p) { return p.type === "long"; }).reduce(function(s, p) { return s + p.size; }, 0);
      if (sellSize > longSize && openPositions.filter(function(p) { return p.type === "short"; }).length === 0) {
        openPositions.push({ type: "short", size: sellSize, entryPrice: currentPrice, note: "" });
        demoBalance -= amount;
      } else if (openPositions.filter(function(p) { return p.type === "short"; }).length > 0) {
        var shortPos = openPositions.find(function(p) { return p.type === "short"; });
        shortPos.size += sellSize;
        shortPos.entryPrice = (shortPos.entryPrice * (shortPos.size - sellSize) + currentPrice * sellSize) / shortPos.size;
        demoBalance -= amount;
      } else {
        alert("Not enough positions to sell");
        return;
      }
      updateDemoDisplay();
      addJournalEntry("sell", sellSize, currentPrice, 0);
    }

    function closePosition(index) {
      var pos = openPositions[index];
      var closeValue = pos.size * currentPrice;
      var cost = pos.size * pos.entryPrice;
      var pnl = pos.type === "long" ? closeValue - cost : cost - closeValue;
      tradeHistory.push({ type: pos.type, size: pos.size, entryPrice: pos.entryPrice, exitPrice: currentPrice, pnl: pnl, note: pos.note });
      demoBalance += closeValue;
      openPositions.splice(index, 1);
      updateDemoDisplay();
      addJournalEntry("close", pos.size, pos.entryPrice, pnl, pos.note);
    }

    function addJournalEntry(type, size, price, pnl, note) {
      var entry = { type: type, size: size, price: price, pnl: pnl, note: note || "", time: new Date().toISOString() };
      tradeHistory.unshift(entry);
      if (tradeHistory.length > 20) tradeHistory.pop();
      renderJournal();
    }

    function renderJournal() {
      var html = "";
      tradeHistory.slice(0, 10).forEach(function(t, i) {
        var typeClass = t.type === "buy" ? "journal-buy" : (t.type === "sell" ? "journal-sell" : "");
        var pnlText = t.pnl >= 0 ? "+$" + t.pnl.toFixed(2) : "-$" + Math.abs(t.pnl).toFixed(2);
        html += '<div class="journal-item" data-index="' + i + '">';
        html += '<div class="journal-header"><span class="journal-type ' + typeClass + '">' + t.type.toUpperCase() + '</span>';
        html += '<span class="journal-pnl ' + (t.pnl >= 0 ? "pnl-positive" : "pnl-negative") + '">' + pnlText + '</span></div>';
        html += '<div style="color:var(--text-secondary);font-size:10px;">' + t.size.toFixed(2) + ' @ $' + t.price.toFixed(8) + '</div>';
        if (t.type === "close" && t.note) {
          html += '<div class="journal-note">' + t.note + '</div>';
        }
        if (t.type === "close") {
          html += '<input type="text" class="journal-note-input" placeholder="Add note..." onchange="updateNote(' + i + ', this.value)">';
        }
        html += '</div>';
      });
      document.getElementById("journal-list").innerHTML = html || '<div style="color:var(--text-secondary);text-align:center;padding:16px;">No trades yet</div>';
    }

    function updateNote(index, note) {
      if (tradeHistory[index]) {
        tradeHistory[index].note = note;
      }
    }

    function updatePositionsDisplay() {
      var html = "";
      var totalUnrealized = 0;
      
      openPositions.forEach(function(pos, idx) {
        var unrealized = pos.type === "long" ? (currentPrice - pos.entryPrice) * pos.size : (pos.entryPrice - currentPrice) * pos.size;
        totalUnrealized += unrealized;
        var pnlClass = unrealized >= 0 ? "pnl-positive" : "pnl-negative";
        
        html += '<div class="position-row"><span style="color:' + (pos.type === "long" ? "#26a69a" : "#ef5350") + ';">' + pos.type.toUpperCase() + '</span>';
        html += '<span>' + pos.size.toFixed(2) + '</span>';
        html += '<span>' + pos.entryPrice.toFixed(8) + '</span>';
        html += '<span class="' + pnlClass + '" style="cursor:pointer;" onclick="closePosition(' + idx + ')">' + (unrealized >= 0 ? "+" : "") + unrealized.toFixed(2) + '</span></div>';
      });
      
      document.getElementById("open-positions").innerHTML = html || '<div style="text-align:center;color:var(--text-secondary);padding:16px;">No open positions</div>';
      
      var closedPnL = tradeHistory.filter(function(t) { return t.type === "close"; }).reduce(function(sum, t) { return sum + t.pnl; }, 0);
      var totalPnL = closedPnL + totalUnrealized;
      var pnlEl = document.getElementById("total-pnl");
      pnlEl.textContent = (totalPnL >= 0 ? "+" : "") + "$" + totalPnL.toFixed(2);
      pnlEl.className = totalPnL >= 0 ? "indicator-value pnl-positive" : "indicator-value pnl-negative";
      
      var wins = tradeHistory.filter(function(t) { return t.type === "close" && t.pnl > 0; }).length;
      var total = tradeHistory.filter(function(t) { return t.type === "close"; }).length;
      document.getElementById("win-rate").textContent = total > 0 ? Math.round((wins / total) * 100) + "%" : "0%";
    }

    function updateDemoDisplay() {
      document.getElementById("demo-balance-header").textContent = "$" + demoBalance.toFixed(2);
      updatePositionsDisplay();
    }

    function resetDemo() {
      if (confirm("Reset all demo trading data?")) {
        demoBalance = 10000;
        openPositions = [];
        tradeHistory = [];
        updateDemoDisplay();
        renderJournal();
      }
    }

    function calculatePosition() {
      var balance = parseFloat(document.getElementById("calcBalance").value) || 0;
      var riskPercent = parseFloat(document.getElementById("calcRisk").value) || 0;
      var stopLossPercent = parseFloat(document.getElementById("calcStopLoss").value) || 0;
      var entryPrice = parseFloat(document.getElementById("calcEntry").value) || 0;
      
      if (balance <= 0 || riskPercent <= 0 || stopLossPercent <= 0 || entryPrice <= 0) {
        document.getElementById("posSize").textContent = "---";
        document.getElementById("posRisk").textContent = "---";
        return;
      }
      
      var riskAmount = balance * (riskPercent / 100);
      var stopLossDistance = entryPrice * (stopLossPercent / 100);
      var positionSize = riskAmount / stopLossDistance;
      
      document.getElementById("posSize").textContent = positionSize.toFixed(0) + " HBAR";
      document.getElementById("posRisk").textContent = "$" + riskAmount.toFixed(2);
    }

    function toggleTheme() {
      isLightTheme = !isLightTheme;
      document.body.classList.toggle("light-theme", isLightTheme);
      var bgColor = isLightTheme ? "#ffffff" : "#131722";
      var gridColor = isLightTheme ? "#e0e0e0" : "#1e222d";
      chart.applyOptions({ layout: { background: { type: "solid", color: bgColor } }, grid: { vertLines: { color: gridColor }, horzLines: { color: gridColor } } });
      volumeChart.applyOptions({ layout: { background: { type: "solid", color: bgColor } }, grid: { vertLines: { color: gridColor }, horzLines: { color: gridColor } } });
    }

    document.addEventListener("keydown", function(e) {
      if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
      
      switch(e.key.toLowerCase()) {
        case "1": setTimeframe("1m"); break;
        case "2": setTimeframe("5m"); break;
        case "3": setTimeframe("15m"); break;
        case "4": setTimeframe("30m"); break;
        case "5": setTimeframe("1h"); break;
        case "6": setTimeframe("4h"); break;
        case "7": setTimeframe("1d"); break;
        case "b": paperBuy(); break;
        case "s": paperSell(); break;
        case "c": setTool("crosshair"); break;
        case "h": setTool("hline"); break;
        case "t": setTool("trend"); break;
        case "v": setTool("vert"); break;
        case "x": clearDrawings(); break;
      }
    });

    function resizeChart() {
      chart.applyOptions({ width: chartContainer.clientWidth, height: chartContainer.clientHeight });
      volumeChart.applyOptions({
        width: document.getElementById("volume-chart").clientWidth,
        height: document.getElementById("volume-chart").clientHeight
      });
    }
    window.addEventListener("resize", resizeChart);
    resizeChart();
    updateDemoDisplay();
    renderJournal();
    loadDrawings();

    loadCandles("1h");
  </script>
</body>
</html>