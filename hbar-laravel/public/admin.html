<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HBAR Trading - Admin Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #c9d1d9; min-height: 100vh; }
    
    .login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .login-box { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 40px; width: 100%; max-width: 400px; }
    .login-box h1 { color: #58a6ff; margin-bottom: 24px; text-align: center; }
    .login-box input { width: 100%; padding: 12px 16px; margin-bottom: 16px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px; }
    .login-box button { width: 100%; padding: 12px; background: #238636; border: none; border-radius: 6px; color: white; font-size: 14px; cursor: pointer; }
    .login-box button:hover { background: #2ea043; }
    .login-error { color: #f85149; margin-bottom: 16px; text-align: center; }
    
    .admin-layout { display: none; }
    .admin-layout.active { display: block; }
    .login-layout.hidden { display: none; }
    
    .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 240px; background: #161b22; border-right: 1px solid #30363d; padding: 20px 0; }
    .sidebar-logo { padding: 0 20px 20px; border-bottom: 1px solid #30363d; margin-bottom: 20px; }
    .sidebar-logo h2 { color: #58a6ff; font-size: 18px; }
    .sidebar-logo span { color: #8b949e; font-size: 12px; }
    .sidebar-menu { list-style: none; }
    .sidebar-menu li { margin-bottom: 4px; }
    .sidebar-menu a { display: flex; align-items: center; padding: 12px 20px; color: #c9d1d9; text-decoration: none; transition: 0.2s; }
    .sidebar-menu a:hover, .sidebar-menu a.active { background: #21262d; color: #58a6ff; border-left: 3px solid #58a6ff; }
    .sidebar-menu .icon { width: 20px; margin-right: 10px; text-align: center; }
    .sidebar-user { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; border-top: 1px solid #30363d; }
    .sidebar-user-info { display: flex; align-items: center; margin-bottom: 12px; }
    .sidebar-user-avatar { width: 36px; height: 36px; background: #238636; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
    .sidebar-user-name { font-size: 14px; }
    .sidebar-user-role { font-size: 12px; color: #8b949e; }
    .logout-btn { width: 100%; padding: 8px; background: #21262d; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; cursor: pointer; }
    .logout-btn:hover { background: #30363d; }
    
    .main-content { margin-left: 240px; padding: 24px; }
    .page-header { margin-bottom: 24px; }
    .page-header h1 { font-size: 24px; margin-bottom: 8px; }
    .page-header p { color: #8b949e; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .stat-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; }
    .stat-card-label { font-size: 14px; color: #8b949e; margin-bottom: 8px; }
    .stat-card-value { font-size: 32px; font-weight: 600; color: #c9d1d9; }
    .stat-card-change { font-size: 14px; margin-top: 8px; }
    .stat-card-change.positive { color: #3fb950; }
    .stat-card-change.negative { color: #f85149; }
    
    .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; margin-bottom: 24px; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid #30363d; display: flex; align-items: center; justify-content: space-between; }
    .card-header h3 { font-size: 16px; }
    .card-body { padding: 20px; }
    
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #30363d; }
    .table th { color: #8b949e; font-weight: 500; font-size: 14px; }
    .table td { font-size: 14px; }
    .table tbody tr:hover { background: #21262d; }
    
    .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .badge-success { background: rgba(63, 185, 80, 0.15); color: #3fb950; }
    .badge-warning { background: rgba(187, 128, 9, 0.15); color: #d29922; }
    .badge-error { background: rgba(248, 81, 73, 0.15); color: #f85149; }
    .badge-info { background: rgba(56, 139, 253, 0.15); color: #58a6ff; }
    
    .btn { padding: 8px 16px; border-radius: 6px; border: none; font-size: 14px; cursor: pointer; transition: 0.2s; }
    .btn-primary { background: #238636; color: white; }
    .btn-primary:hover { background: #2ea043; }
    .btn-secondary { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; }
    .btn-secondary:hover { background: #30363d; }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    
    .search-input { padding: 8px 12px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px; }
    .search-input:focus { outline: none; border-color: #58a6ff; }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid #30363d; padding-bottom: 16px; }
    .tab { padding: 8px 16px; background: none; border: none; color: #8b949e; cursor: pointer; font-size: 14px; }
    .tab:hover { color: #c9d1d9; }
    .tab.active { color: #58a6ff; background: rgba(56, 139, 253, 0.1); border-radius: 6px; }
    
    .chart-container { height: 300px; display: flex; align-items: flex-end; gap: 4px; padding: 20px 0; }
    .chart-bar { flex: 1; background: linear-gradient(to top, #238636, #3fb950); border-radius: 4px 4px 0 0; min-height: 4px; transition: 0.3s; }
    .chart-bar:hover { background: linear-gradient(to top, #2ea043, #56d364); }
    
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: #161b22; border: 1px solid #30363d; border-radius: 8px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid #30363d; display: flex; align-items: center; justify-content: space-between; }
    .modal-header h3 { font-size: 18px; }
    .modal-close { background: none; border: none; color: #8b949e; font-size: 24px; cursor: pointer; }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #8b949e; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 14px; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #58a6ff; }
    .modal-footer { padding: 20px; border-top: 1px solid #30363d; display: flex; gap: 12px; justify-content: flex-end; }
    
    .pagination { display: flex; align-items: center; gap: 8px; margin-top: 20px; }
    .pagination button { padding: 8px 12px; background: #21262d; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; cursor: pointer; }
    .pagination button:hover:not(:disabled) { background: #30363d; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination span { margin: 0 16px; color: #8b949e; font-size: 14px; }
    
    .empty-state { text-align: center; padding: 60px 20px; color: #8b949e; }
    .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
    
    .user-email { color: #58a6ff; }
    .user-name { display: flex; align-items: center; gap: 8px; }
    .user-avatar { width: 28px; height: 28px; background: #30363d; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    
    .plan-card { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 20px; margin-bottom: 16px; }
    .plan-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .plan-name { font-size: 18px; font-weight: 600; }
    .plan-price { font-size: 24px; font-weight: 600; color: #58a6ff; }
    .plan-price span { font-size: 14px; color: #8b949e; font-weight: normal; }
    .plan-features { list-style: none; margin: 16px 0; }
    .plan-features li { padding: 8px 0; border-bottom: 1px solid #21262d; display: flex; align-items: center; gap: 8px; }
    .plan-features li::before { content: "âœ“"; color: #3fb950; }
    
    .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
    .spinner { width: 40px; height: 40px; border: 3px solid #30363d; border-top-color: #58a6ff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 1024px) { .grid-2 { grid-template-columns: 1fr; } }
    
    .text-right { text-align: right; }
    .text-green { color: #3fb950; }
    .text-red { color: #f85149; }
    
    .dropdown { position: relative; }
    .dropdown-menu { position: absolute; right: 0; top: 100%; background: #161b22; border: 1px solid #30363d; border-radius: 6px; min-width: 150px; z-index: 100; display: none; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 8px 16px; display: block; color: #c9d1d9; text-decoration: none; font-size: 14px; cursor: pointer; }
    .dropdown-item:hover { background: #21262d; }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div class="login-page login-layout" id="loginPage">
    <div class="login-box">
      <h1>Admin Login</h1>
      <div class="login-error" id="loginError"></div>
      <form id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button type="submit">Sign In</button>
      </form>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div class="admin-layout" id="adminLayout">
    <nav class="sidebar">
      <div class="sidebar-logo">
        <h2>HBAR Trading</h2>
        <span>Admin Dashboard</span>
      </div>
      <ul class="sidebar-menu">
        <li><a href="#" class="active" data-page="dashboard"><span class="icon">ðŸ“Š</span> Dashboard</a></li>
        <li><a href="#" data-page="users"><span class="icon">ðŸ‘¥</span> Users</a></li>
        <li><a href="#" data-page="subscriptions"><span class="icon">ðŸ’³</span> Subscriptions</a></li>
        <li><a href="#" data-page="payments"><span class="icon">ðŸ’°</span> Payments</a></li>
        <li><a href="#" data-page="plans"><span class="icon">ðŸ“‹</span> Plans</a></li>
        <li><a href="#" data-page="analytics"><span class="icon">ðŸ“ˆ</span> Analytics</a></li>
      </ul>
      <div class="sidebar-user">
        <div class="sidebar-user-info">
          <div class="sidebar-user-avatar">A</div>
          <div>
            <div class="sidebar-user-name" id="adminName">Admin</div>
            <div class="sidebar-user-role" id="adminRole">Super Admin</div>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">Sign Out</button>
      </div>
    </nav>

    <main class="main-content">
      <!-- Dashboard Page -->
      <div id="page-dashboard" class="page">
        <div class="page-header">
          <h1>Dashboard</h1>
          <p>Overview of your trading platform</p>
        </div>
        
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-card-label">Total Users</div>
            <div class="stat-card-value" id="statUsers">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-card-label">Active Subscriptions</div>
            <div class="stat-card-value" id="statSubs">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-card-label">Total Revenue</div>
            <div class="stat-card-value" id="statRevenue">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-card-label">Monthly Revenue</div>
            <div class="stat-card-value" id="statMonthly">-</div>
          </div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <h3>Subscriptions by Plan</h3>
            </div>
            <div class="card-body" id="planStats"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Recent Signups</h3>
            </div>
            <div class="card-body" id="recentUsers"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Recent Payments</h3>
          </div>
          <div class="card-body" id="recentPayments"></div>
        </div>
      </div>

      <!-- Users Page -->
      <div id="page-users" class="page" style="display:none;">
        <div class="page-header">
          <h1>Users</h1>
          <p>Manage platform users</p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3>All Users</h3>
            <input type="text" class="search-input" placeholder="Search users..." id="userSearch" onkeyup="searchUsers()">
          </div>
          <div class="card-body">
            <div id="usersTable"></div>
            <div class="pagination" id="usersPagination"></div>
          </div>
        </div>
      </div>

      <!-- Subscriptions Page -->
      <div id="page-subscriptions" class="page" style="display:none;">
        <div class="page-header">
          <h1>Subscriptions</h1>
          <p>Manage user subscriptions</p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3>Active Subscriptions</h3>
          </div>
          <div class="card-body">
            <div id="subscriptionsTable"></div>
          </div>
        </div>
      </div>

      <!-- Payments Page -->
      <div id="page-payments" class="page" style="display:none;">
        <div class="page-header">
          <h1>Payments</h1>
          <p>View all payment transactions</p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3>All Payments</h3>
          </div>
          <div class="card-body">
            <div id="paymentsTable"></div>
          </div>
        </div>
      </div>

      <!-- Plans Page -->
      <div id="page-plans" class="page" style="display:none;">
        <div class="page-header">
          <h1>Subscription Plans</h1>
          <p>Manage pricing plans</p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3>Plans</h3>
            <button class="btn btn-primary btn-sm" onclick="openPlanModal()">+ Add Plan</button>
          </div>
          <div class="card-body" id="plansList"></div>
        </div>
      </div>

      <!-- Analytics Page -->
      <div id="page-analytics" class="page" style="display:none;">
        <div class="page-header">
          <h1>Analytics</h1>
          <p>Revenue and user analytics</p>
        </div>
        
        <div class="tabs">
          <button class="tab active" onclick="showAnalytics('revenue')">Revenue</button>
          <button class="tab" onclick="showAnalytics('users')">User Growth</button>
        </div>
        
        <div id="analytics-revenue">
          <div class="card">
            <div class="card-header">
              <h3>Revenue by Plan</h3>
            </div>
            <div class="card-body" id="revenueByPlan"></div>
          </div>
        </div>
        
        <div id="analytics-users" style="display:none;">
          <div class="card">
            <div class="card-header">
              <h3>User Signups (Last 30 Days)</h3>
            </div>
            <div class="card-body" id="userSignups"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Plan Modal -->
  <div class="modal" id="planModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="planModalTitle">Add Plan</h3>
        <button class="modal-close" onclick="closePlanModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="planForm">
          <input type="hidden" id="planId">
          <div class="form-group">
            <label>Plan Name</label>
            <input type="text" id="planName" required>
          </div>
          <div class="form-group">
            <label>Slug</label>
            <input type="text" id="planSlug" required>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="planDescription" rows="2"></textarea>
          </div>
          <div class="form-group">
            <label>Monthly Price ($)</label>
            <input type="number" id="planMonthly" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Yearly Price ($)</label>
            <input type="number" id="planYearly" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Max Alerts (-1 = unlimited)</label>
            <input type="number" id="planMaxAlerts" value="5">
          </div>
          <div class="form-group">
            <label>Max Drawings (-1 = unlimited)</label>
            <input type="number" id="planMaxDrawings" value="10">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="planBacktesting"> Enable Backtesting
            </label>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="planReplay"> Enable Replay Mode
            </label>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="planActive" checked> Active
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePlanModal()">Cancel</button>
        <button class="btn btn-primary" onclick="savePlan()">Save Plan</button>
      </div>
    </div>
  </div>

  <!-- User Detail Modal -->
  <div class="modal" id="userModal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3>User Details</h3>
        <button class="modal-close" onclick="closeUserModal()">&times;</button>
      </div>
      <div class="modal-body" id="userModalBody">
        <div class="loading"><div class="spinner"></div></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeUserModal()">Close</button>
        <button class="btn btn-primary" onclick="updateUserSubscription()">Update Subscription</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';
    let adminToken = localStorage.getItem('adminToken');
    let adminData = JSON.parse(localStorage.getItem('adminData') || 'null');

    // Check auth
    if (adminToken) {
      showAdmin();
    } else {
      showLogin();
    }

    function showLogin() {
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('adminLayout').classList.remove('active');
    }

    function showAdmin() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('adminLayout').classList.add('active');
      document.getElementById('adminName').textContent = adminData?.name || 'Admin';
      document.getElementById('adminRole').textContent = adminData?.role || 'Admin';
      loadDashboard();
    }

    // Login
    document.getElementById('loginForm').onsubmit = async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        const res = await fetch(`${API_URL}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        
        if (data.error) {
          document.getElementById('loginError').textContent = data.error;
        } else {
          adminToken = data.token;
          adminData = data.admin;
          localStorage.setItem('adminToken', adminToken);
          localStorage.setItem('adminData', JSON.stringify(adminData));
          showAdmin();
        }
      } catch (e) {
        document.getElementById('loginError').textContent = 'Connection error';
      }
    };

    function logout() {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminData');
      adminToken = null;
      adminData = null;
      showLogin();
    }

    // Navigation
    document.querySelectorAll('.sidebar-menu a').forEach(link => {
      link.onclick = (e) => {
        e.preventDefault();
        const page = link.dataset.page;
        document.querySelectorAll('.sidebar-menu a').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById(`page-${page}`).style.display = 'block';
        
        if (page === 'dashboard') loadDashboard();
        if (page === 'users') loadUsers();
        if (page === 'subscriptions') loadSubscriptions();
        if (page === 'payments') loadPayments();
        if (page === 'plans') loadPlans();
        if (page === 'analytics') loadAnalytics();
      };
    });

    // API helper
    async function adminFetch(url, options = {}) {
      const res = await fetch(url, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${adminToken}`,
          ...options.headers
        }
      });
      const data = await res.json();
      if (data.error && res.status === 401) logout();
      return data;
    }

    // Dashboard
    async function loadDashboard() {
      const data = await adminFetch(`${API_URL}/admin/stats`);
      
      document.getElementById('statUsers').textContent = data.totalUsers || 0;
      document.getElementById('statSubs').textContent = data.activeSubs || 0;
      document.getElementById('statRevenue').textContent = `$${(data.totalRevenue || 0).toFixed(2)}`;
      document.getElementById('statMonthly').textContent = `$${(data.monthlyRevenue || 0).toFixed(2)}`;
      
      // Plan stats
      const planHtml = Object.entries(data.planStats || {}).map(([name, count]) => 
        `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #21262d;">
          <span>${name}</span>
          <span class="badge badge-info">${count}</span>
        </div>`
      ).join('');
      document.getElementById('planStats').innerHTML = planHtml || '<p>No subscriptions yet</p>';
      
      // Recent users
      const usersHtml = (data.recentUsers || []).map(u => 
        `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #21262d;">
          <div class="user-name">
            <div class="user-avatar">${(u.name || 'T')[0].toUpperCase()}</div>
            <div>
              <div class="user-email">${u.email}</div>
              <small style="color:#8b949e">${new Date(u.created_at).toLocaleDateString()}</small>
            </div>
          </div>
        </div>`
      ).join('');
      document.getElementById('recentUsers').innerHTML = usersHtml || '<p>No users yet</p>';
      
      // Recent payments
      const paymentsHtml = (data.recentPayments || []).map(p => 
        `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #21262d;">
          <div>
            <span class="user-email">${p.profiles?.email || 'Unknown'}</span>
            <small style="color:#8b949e;display:block">${new Date(p.created_at).toLocaleString()}</small>
          </div>
          <div class="text-right">
            <div style="color:#3fb950">+$${parseFloat(p.amount).toFixed(2)}</div>
            <span class="badge badge-${p.status === 'completed' ? 'success' : p.status === 'pending' ? 'warning' : 'error'}">${p.status}</span>
          </div>
        </div>`
      ).join('');
      document.getElementById('recentPayments').innerHTML = paymentsHtml || '<p>No payments yet</p>';
    }

    // Users
    let usersPage = 1;
    async function loadUsers(page = 1) {
      usersPage = page;
      const search = document.getElementById('userSearch')?.value || '';
      const data = await adminFetch(`${API_URL}/admin/users?page=${page}&limit=20&search=${search}`);
      
      const html = `
        <table class="table">
          <thead><tr><th>User</th><th>Created</th><th>Plan</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody>
            ${(data.users || []).map(u => `
              <tr>
                <td>
                  <div class="user-name">
                    <div class="user-avatar">${(u.name || 'T')[0].toUpperCase()}</div>
                    <div>
                      <div>${u.name || 'Trader'}</div>
                      <small class="user-email">${u.email}</small>
                    </div>
                  </div>
                </td>
                <td>${new Date(u.created_at).toLocaleDateString()}</td>
                <td>${u.subscription?.plans?.name || '-'}</td>
                <td><span class="badge ${u.subscription?.status === 'active' ? 'badge-success' : 'badge-warning'}">${u.subscription?.status || 'Free'}</span></td>
                <td><button class="btn btn-sm btn-secondary" onclick="viewUser('${u.id}')">View</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('usersTable').innerHTML = html || '<div class="empty-state"><p>No users found</p></div>';
      
      // Pagination
      const pagination = document.getElementById('usersPagination');
      pagination.innerHTML = `
        <button ${page === 1 ? 'disabled' : ''} onclick="loadUsers(${page - 1})">Previous</button>
        <span>Page ${page} of ${data.totalPages || 1}</span>
        <button ${page >= (data.totalPages || 1) ? 'disabled' : ''} onclick="loadUsers(${page + 1})">Next</button>
      `;
    }

    function searchUsers() {
      loadUsers(1);
    }

    async function viewUser(id) {
      document.getElementById('userModal').classList.add('active');
      const data = await adminFetch(`${API_URL}/admin/users/${id}`);
      
      document.getElementById('userModalBody').innerHTML = `
        <div style="margin-bottom:20px">
          <strong>${data.user.name || 'Trader'}</strong><br>
          <span class="user-email">${data.user.email}</span><br>
          <small>Joined: ${new Date(data.user.created_at).toLocaleString()}</small>
        </div>
        <h4 style="margin:16px 0 8px">Subscription</h4>
        <p>Plan: ${data.subscription?.plans?.name || 'Free'}</p>
        <p>Status: ${data.subscription?.status || 'N/A'}</p>
        <p>Next billing: ${data.subscription?.current_period_end ? new Date(data.subscription.current_period_end).toLocaleDateString() : 'N/A'}</p>
        <h4 style="margin:16px 0 8px">Recent Trades (${data.trades.length})</h4>
        <div style="max-height:200px;overflow-y:auto">
          ${data.trades.map(t => `
            <div style="padding:8px 0;border-bottom:1px solid #21262d;display:flex;justify-content:space-between">
              <span>${t.type.toUpperCase()} ${t.symbol}</span>
              <span>$${t.pnl.toFixed(2)}</span>
            </div>
          `).join('')}
        </div>
        <h4 style="margin:16px 0 8px">Recent Payments (${data.payments.length})</h4>
        <div style="max-height:200px;overflow-y:auto">
          ${data.payments.map(p => `
            <div style="padding:8px 0;border-bottom:1px solid #21262d;display:flex;justify-content:space-between">
              <span>${new Date(p.created_at).toLocaleDateString()}</span>
              <span class="text-green">+$${parseFloat(p.amount).toFixed(2)}</span>
            </div>
          `).join('')}
        </div>
      `;
      window.currentUserId = id;
    }

    function closeUserModal() {
      document.getElementById('userModal').classList.remove('active');
    }

    // Subscriptions
    async function loadSubscriptions() {
      const users = await adminFetch(`${API_URL}/admin/users?limit=100`);
      const plans = await adminFetch(`${API_URL}/admin/plans`);
      
      const subs = (users.users || []).filter(u => u.subscription);
      
      const html = `
        <table class="table">
          <thead><tr><th>User</th><th>Plan</th><th>Billing</th><th>Status</th><th>Expires</th></tr></thead>
          <tbody>
            ${subs.map(u => `
              <tr>
                <td>
                  <div class="user-name">
                    <div class="user-avatar">${(u.name || 'T')[0].toUpperCase()}</div>
                    <span>${u.email}</span>
                  </div>
                </td>
                <td>${u.subscription.plans?.name || 'Unknown'}</td>
                <td>${u.subscription.billing_cycle}</td>
                <td><span class="badge badge-${u.subscription.status === 'active' ? 'success' : 'warning'}">${u.subscription.status}</span></td>
                <td>${u.subscription.current_period_end ? new Date(u.subscription.current_period_end).toLocaleDateString() : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('subscriptionsTable').innerHTML = html || '<div class="empty-state"><p>No active subscriptions</p></div>';
    }

    // Payments
    async function loadPayments() {
      const data = await adminFetch(`${API_URL}/admin/payments?limit=50`);
      
      const html = `
        <table class="table">
          <thead><tr><th>User</th><th>Amount</th><th>Status</th><th>Method</th><th>Date</th></tr></thead>
          <tbody>
            ${(data.payments || []).map(p => `
              <tr>
                <td>
                  <div class="user-email">${p.profiles?.email || 'Unknown'}</div>
                </td>
                <td class="text-green">+$${parseFloat(p.amount).toFixed(2)}</td>
                <td><span class="badge badge-${p.status === 'completed' ? 'success' : p.status === 'pending' ? 'warning' : 'error'}">${p.status}</span></td>
                <td>${p.payment_method || '-'}</td>
                <td>${new Date(p.created_at).toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('paymentsTable').innerHTML = html || '<div class="empty-state"><p>No payments found</p></div>';
    }

    // Plans
    async function loadPlans() {
      const data = await adminFetch(`${API_URL}/admin/plans`);
      
      const html = (data || []).map(plan => `
        <div class="plan-card">
          <div class="plan-card-header">
            <div>
              <div class="plan-name">${plan.name}</div>
              <small style="color:#8b949e">${plan.description || ''}</small>
            </div>
            <div class="text-right">
              <div class="plan-price">$${plan.price_monthly}<span>/mo</span></div>
              <span class="badge ${plan.is_active ? 'badge-success' : 'badge-error'}">${plan.is_active ? 'Active' : 'Inactive'}</span>
            </div>
          </div>
          <div class="plan-features">
            <li>Max Alerts: ${plan.limits?.max_alerts === -1 ? 'Unlimited' : plan.limits?.max_alerts}</li>
            <li>Max Drawings: ${plan.limits?.max_drawings === -1 ? 'Unlimited' : plan.limits?.max_drawings}</li>
            <li>Backtesting: ${plan.limits?.backtesting ? 'âœ“' : 'âœ—'}</li>
            <li>Replay Mode: ${plan.limits?.replay_mode ? 'âœ“' : 'âœ—'}</li>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="editPlan('${plan.id}')">Edit</button>
            <button class="btn btn-secondary btn-sm" onclick="deletePlan('${plan.id}')">Delete</button>
          </div>
        </div>
      `).join('');
      document.getElementById('plansList').innerHTML = html || '<div class="empty-state"><p>No plans defined</p></div>';
    }

    function openPlanModal(plan = null) {
      document.getElementById('planModal').classList.add('active');
      document.getElementById('planModalTitle').textContent = plan ? 'Edit Plan' : 'Add Plan';
      
      if (plan) {
        document.getElementById('planId').value = plan.id;
        document.getElementById('planName').value = plan.name;
        document.getElementById('planSlug').value = plan.slug;
        document.getElementById('planDescription').value = plan.description || '';
        document.getElementById('planMonthly').value = plan.price_monthly;
        document.getElementById('planYearly').value = plan.price_yearly;
        document.getElementById('planMaxAlerts').value = plan.limits?.max_alerts || 5;
        document.getElementById('planMaxDrawings').value = plan.limits?.max_drawings || 10;
        document.getElementById('planBacktesting').checked = plan.limits?.backtesting || false;
        document.getElementById('planReplay').checked = plan.limits?.replay_mode || false;
        document.getElementById('planActive').checked = plan.is_active;
      } else {
        document.getElementById('planForm').reset();
        document.getElementById('planId').value = '';
        document.getElementById('planActive').checked = true;
      }
    }

    function closePlanModal() {
      document.getElementById('planModal').classList.remove('active');
    }

    async function savePlan() {
      const id = document.getElementById('planId').value;
      const plan = {
        name: document.getElementById('planName').value,
        slug: document.getElementById('planSlug').value,
        description: document.getElementById('planDescription').value,
        price_monthly: parseFloat(document.getElementById('planMonthly').value),
        price_yearly: parseFloat(document.getElementById('planYearly').value),
        is_active: document.getElementById('planActive').checked,
        limits: {
          max_alerts: parseInt(document.getElementById('planMaxAlerts').value),
          max_drawings: parseInt(document.getElementById('planMaxDrawings').value),
          backtesting: document.getElementById('planBacktesting').checked,
          replay_mode: document.getElementById('planReplay').checked
        }
      };
      
      if (id) {
        await adminFetch(`${API_URL}/admin/plans/${id}`, {
          method: 'PUT',
          body: JSON.stringify(plan)
        });
      } else {
        await adminFetch(`${API_URL}/admin/plans`, {
          method: 'POST',
          body: JSON.stringify(plan)
        });
      }
      
      closePlanModal();
      loadPlans();
    }

    async function editPlan(id) {
      const plans = await adminFetch(`${API_URL}/admin/plans`);
      const plan = plans.find(p => p.id === id);
      if (plan) openPlanModal(plan);
    }

    async function deletePlan(id) {
      if (!confirm('Delete this plan?')) return;
      await adminFetch(`${API_URL}/admin/plans/${id}`, { method: 'DELETE' });
      loadPlans();
    }

    // Analytics
    async function loadAnalytics() {
      const revenueData = await adminFetch(`${API_URL}/admin/analytics/revenue?period=30`);
      const userData = await adminFetch(`${API_URL}/admin/analytics/users`);
      
      // Revenue by plan
      const revenueHtml = Object.entries(revenueData.revenueByPlan || {}).map(([plan, amount]) => `
        <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #21262d;">
          <span>${plan}</span>
          <span class="text-green">$${amount.toFixed(2)}</span>
        </div>
      `).join('');
      document.getElementById('revenueByPlan').innerHTML = revenueHtml || '<p>No revenue data</p>';
      
      // User signups chart (simplified bar chart)
      const maxVal = Math.max(...Object.values(userData.signupsByDay || {}), 1);
      const chartHtml = Object.entries(userData.signupsByDay || {}).slice(-14).map(([date, count]) => `
        <div style="flex:1;display:flex;flex-direction:column;align-items:center">
          <div style="width:100%;height:${(count / maxVal) * 150}px;background:#238636;border-radius:4px 4px 0 0;margin-bottom:4px"></div>
          <small style="color:#8b949e;font-size:10px">${date.slice(5)}</small>
        </div>
      `).join('');
      document.getElementById('userSignups').innerHTML = `<div style="display:flex;align-items:flex-end;gap:2px;height:180px">${chartHtml}</div>`;
    }

    function showAnalytics(type) {
      document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('analytics-revenue').style.display = type === 'revenue' ? 'block' : 'none';
      document.getElementById('analytics-users').style.display = type === 'users' ? 'block' : 'none';
    }
  </script>
</body>
</html>
